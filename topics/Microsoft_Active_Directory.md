## Microsoft Active Directory
***

**Active Directory** («Активный каталог», AD) — службы каталогов корпорации Microsoft для операционных систем семейства Windows Server. Первоначально создавалась, как LDAP-совместимая реализация службы каталогов, однако, начиная с Windows Server 2008, включает возможности интеграции с другими службами авторизации, выполняя для них интегрирующую и объединяющую роль. Позволяет администраторам использовать групповые политики для обеспечения единообразия настройки пользовательской рабочей среды, разворачивать программное обеспечение на множестве компьютеров через групповые политики или посредством System Center Configuration Manager (ранее — Microsoft Systems Management Server), устанавливать обновления операционной системы, прикладного и серверного программного обеспечения на всех компьютерах в сети, используя Службу обновления Windows Server. Хранит данные и настройки среды в централизованной базе данных. Сети Active Directory могут быть различного размера: от нескольких десятков до нескольких миллионов объектов.

Представление решения состоялось в 1999 году, впервые продукт был выпущен вместе с Windows 2000 Server, а затем развит в рамках выпуска Windows Server 2003. Впоследствии новые версии продукта вошли в Windows Server 2003 R2, Windows Server 2008 и Windows Server 2008 R2 и переименован в Active Directory Domain Services. Ранее служба каталогов называлась NT Directory Service (NTDS), это название до сих пор можно встретить в некоторых исполняемых файлах.

В отличие от версий Windows до Windows 2000, которые использовали в основном протокол NetBIOS для сетевого взаимодействия, служба Active Directory интегрирована с DNS и работает только поверх TCP/IP. Для аутентификации по умолчанию используется протокол Kerberos. Если клиент или приложение не поддерживает Kerberos-аутентификацию, используется протокол NTLM[1].

Для разработчиков программного обеспечения предоставляется программный интерфейс доступа к службам Active Directory — ADSI.

### Domain Services
***

Domaion Services представляет собой комбинацию из сетевых служб LDAP для хранения информации об объектах и Kerberos для аутентификации. Дополнительно к ним на клиенткой стороне существует специальная служба, обеспечивающая применение политик безопасности из центрального хранилища. Информация о политиках хранится в базе LDAP, сами политики представляют собой текстовые файлы на сетевом ресурсе, доступном всем пользователям домена. LDAP база является упрощённой реализацией распределённого каталога Х.500.

### Group Policy
***

Групповые политики используются для централизованной настройки окружения пользователя, рабочих станций и серверов. Каждая групповая политика представляет собой тестовый файл с перечислением пунктов и значением настроек, которые могут быть применены. Настройки можно разделить на две большие группы - для компьютеров и для пользователей. За применение настроек на локальной машине отвечает специальный клиент. Политики обновляются каждый раз при перезагрузке компьютера, при входе пользователя в систему (только политики, применимые к пользователю), раз в примерно 2 часа или принудительно запуском утилиты gpupdate.exe.

Чтобы связать групповую политику с объектами MS AD используются организационные единицы (organizational unit). Это контейнеры в каталоге MS AD, позволяющие группировать другие объекты. Ближайшая аналогия для организационных единиц - каталоги на файловой системе, по которым группируются файлы. Главное применение организационных единиц - связывание сгруппированных в них объектов с действующими на них политиками. По аналогии с каталогами файловой системы, групповая политика действует на все объекты внутри организационной единицы и на все объекты во вложенных организационных единицах. Это поведение можно изменить, но крайне не рекомендуется, так как приводит к очень нелогичным конфигурациям, которые сложно обслуживать.

Для создания политик, внесения в них изменений и связывания с объектами каталога существует специальная оснастка в mmc консоли на сервере MS AD - Group Policy Management.

### Подключение клиентов
***

Для ввода в домен нового компьютера потребуется корректно установленный контроллер домена. Корректность его установки проверяется с помощью запуска утилиты dcdiag в командной строке. При отсутствии ошибок в выводе домен установлен корректно. Наиболее частая ошибка при установке - некорректная настройка DNS сервера. Для работы MS AD желательно разрешить домен-контроллеру вносить изменения в DNS записи, в идеале иметь на каждом домен контроллере свой DNS сервер от MS. Если это не возможно, допускается ручная регистрация записей. Их список можно посмотреть по ссылке. В нашем случае при установке нужно обратить внимание, чтобы был установлен и настроен DNS сервер. Если домен-контроллер имеет статический адрес, то при установке DNS сервера все записи будут внесены автоматически.

Для виртуальных машин в системе oVirt для корректной работы сети и службы DNS обязательно нужно выключить адресацию IPv6. Иначе всегда будет ошибка с невозможностью определения адреса домена.

Для каждого клиента в качестве DNS сервера должен быть установлен адрес домен-контроллера. После этого в Windows в том же диалоговом окне, где меняется имя компьютера можно изменить домен (переключив ПК с рабочей группы). Для входа в домен потребуется учётная запись домена с правами, достаточными для этого действия. С настройками по умолчанию обычный пользователь может ввести в домен 3 компьютера, администратор без ограничений. Можно делегировать права ввода в домен специальным учётным записям, чтобы эту операцию могли проводить техники без участия главного администратора.

При подключении Linux в домен будет доступна централизованная аутентификация через базу домена и возможность локально использовать группы безопасности из домена. Групповые политики в Linux не поддерживаются. Существует два варианта включения Linxu в домен MS AD: с помощью sssd или winbind/samba. В первом случае потребуется установка службы sssd с зависимостями:

*apt -y install realmd sssd sssd-tools adcli krb5-user packagekit samba-common samba-common-bin samba-libs resolvconf*
Проверить доступности домена:

*realm discover mydomain.local*
Подключиться к нему с помощью команды

*realm join mydomain.local*
И добавить настройку, создающую профиль пользователя домена при первом входе. Для этого в файле /etc/pam.d/common-session добавить строчку (если она не была добавлена автоматически):

*session optional        pam_mkhomedir.so skel=/etc/skel umask=077*
